<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scratch SB3 Cleaner</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>Scratch SB3 Cleaner</h2>
    <input type="file" id="fileInput" accept=".sb3">
    <label><input type="checkbox" id="minifyVars"> Minify Variables</label>
    <button id="cleanBtn">Clean Project</button>
    <progress id="progressBar" max="100" value="0" style="width:100%;"></progress>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const cleanBtn = document.getElementById('cleanBtn');
    const progressBar = document.getElementById('progressBar');
    const minifyBox = document.getElementById('minifyVars');

    function updateProgress(val) {
      progressBar.value = val;
    }

    function generateShortNames(count) {
      const names = []
      const chars = 'abcdefghijklmnopqrstuvwxyz'
      for (let i = 0; i < chars.length && names.length < count; i++) names.push(chars[i])
      for (let i = 0; i < chars.length && names.length < count; i++)
        for (let j = 0; j < chars.length && names.length < count; j++)
          names.push(chars[i]+chars[j])
      return names
    }

    function cleanJSON(project, minify) {
      const fullText = JSON.stringify(project)

      // Clean stage variables
      const stage = project.targets.find(t => t.isStage)
      const globalVars = stage.variables || {}
      const keepGlobal = {}
      for (const [id, val] of Object.entries(globalVars)) {
        const safeID = id.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
        if ((fullText.match(new RegExp(safeID, 'g')) || []).length > 1)
          keepGlobal[id] = val
      }
      stage.variables = keepGlobal

      // Clean sprite/local variables
      project.targets.forEach(target => {
        if (target.isStage) return
        const localVars = target.variables || {}
        const keepLocal = {}
        const targetText = JSON.stringify(target)
        for (const [id, val] of Object.entries(localVars)) {
          const safeID = id.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
          if ((targetText.match(new RegExp(safeID, 'g')) || []).length > 1)
            keepLocal[id] = val
        }
        target.variables = keepLocal
      })

      // Clean shadow input text
      project.targets.forEach(target => {
        for (const block of Object.values(target.blocks || {})) {
          if (!block.inputs) continue
          for (const key in block.inputs) {
            const val = block.inputs[key]
            if (Array.isArray(val) && val.length >= 3 && val[0] === 3 && typeof val[1] === 'string') {
              if (Array.isArray(val[2]) && typeof val[2][1] === 'string') val[2][1] = ''
            }
          }
        }
      })

      // Clean unused sounds
      const allText = JSON.stringify(project)
      project.targets.forEach(target => {
        if (!target.sounds) return
        target.sounds = target.sounds.filter(s => {
          const safeID = s.assetId.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
          return (allText.match(new RegExp(safeID, 'g')) || []).length > 1
        })
      })

      // Minify variable/list names
      if (minify) {
        let allVars = []
        project.targets.forEach(t => {
          if (!t.variables) return
          for (const [id, v] of Object.entries(t.variables)) allVars.push({ target: t, id, val: v })
        })
        const names = generateShortNames(allVars.length)
        allVars.forEach((v, i) => {
          const newName = names[i]
          const oldName = v.val[0]
          const oldID = v.id
          v.val[0] = newName
          const safeOldName = oldName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
          const safeOldID = oldID.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
          const str = JSON.stringify(project)
            .replaceAll(new RegExp(safeOldName, 'g'), newName)
            .replaceAll(new RegExp(safeOldID, 'g'), oldID)
          project = JSON.parse(str)
        })
      }

      return project
    }

    cleanBtn.onclick = async () => {
      const file = fileInput.files[0]
      if (!file) return
      updateProgress(10)

      const zip = await JSZip.loadAsync(file)
      updateProgress(30)

      const jsonData = await zip.file("project.json").async("string")
      const project = JSON.parse(jsonData)
      updateProgress(40)

      const cleaned = cleanJSON(project, minifyBox.checked)
      updateProgress(60)

      zip.file("project.json", JSON.stringify(cleaned))
      updateProgress(80)

      const blob = await zip.generateAsync({ type: "blob" })
      updateProgress(100)

      const a = document.createElement('a')
      a.href = URL.createObjectURL(blob)
      a.download = file.name.replace('.sb3', '_cleaned.sb3')
      a.click()
    }
  </script>
</body>
</html>
